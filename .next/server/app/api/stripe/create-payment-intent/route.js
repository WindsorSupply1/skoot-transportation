"use strict";(()=>{var e={};e.id=5798,e.ids=[5798],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},61282:e=>{e.exports=require("child_process")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},21764:e=>{e.exports=require("util")},42384:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>b,patchFetch:()=>y,requestAsyncStorage:()=>g,routeModule:()=>l,serverHooks:()=>k,staticGenerationAsyncStorage:()=>h});var o={};r.r(o),r.d(o,{POST:()=>m,dynamic:()=>d});var n=r(49303),a=r(88716),s=r(60670),i=r(87070),u=r(48472),p=r(20728),c=r(46029);let d="force-dynamic";async function m(e){try{let{bookingId:t,amount:r,currency:o="usd"}=await e.json();if(!t||!r)return i.NextResponse.json({error:"Missing required fields: bookingId, amount"},{status:400});let n=null;if(t.startsWith("mock_booking_")?(console.log("Payment Intent: Processing mock booking for testing"),n={id:t,bookingNumber:`SK${Date.now().toString().slice(-6)}`,totalAmount:r,status:"PENDING",departure:{date:new Date,schedule:{time:"14:00",route:{name:"Columbia to Charlotte Airport"}}},pickupLocation:{name:"Downtown Columbia"},dropoffLocation:{name:"Charlotte Airport"},user:null,guestEmail:"test@example.com",passengerCount:1,passengers:[]}):n=await p._.booking.findUnique({where:{id:t},include:{departure:{include:{schedule:{include:{route:!0}}}},pickupLocation:!0,dropoffLocation:!0,user:!0,passengers:!0}}),!n)return console.error("Booking not found for ID:",t),i.NextResponse.json({error:"Booking not found"},{status:404});if("PENDING"!==n.status)return i.NextResponse.json({error:"Booking payment already processed"},{status:400});let a=Math.round(100*n.totalAmount),s=Math.round(100*r);if(s!==a)return i.NextResponse.json({error:"Amount mismatch",expected:a/100,received:s/100},{status:400});let u=await c.Ag.paymentIntents.create({amount:a,currency:o,metadata:{bookingId:n.id,bookingNumber:n.bookingNumber,customerEmail:n.user?.email||n.guestEmail||"",departureDate:n.departure.date.toISOString(),passengerCount:n.passengerCount.toString(),route:n.departure.schedule.route.name},description:`Skoot Transportation - ${n.departure.schedule.route.name} - ${n.passengerCount} passenger(s)`,receipt_email:n.user?.email||n.guestEmail||void 0,automatic_payment_methods:{enabled:!0}});if(!t.startsWith("mock_booking_"))try{await p._.payment.create({data:{bookingId:n.id,transactionId:u.id,amount:n.totalAmount,currency:o.toUpperCase(),status:"PENDING",paymentMethod:"STRIPE"}})}catch(e){console.error("Failed to store payment in database:",e)}return i.NextResponse.json({clientSecret:u.client_secret,paymentIntentId:u.id,amount:a,booking:{bookingNumber:n.bookingNumber,totalAmount:n.totalAmount,passengerCount:n.passengerCount,departure:{date:n.departure.date,time:n.departure.schedule.time,route:n.departure.schedule.route.name},pickupLocation:n.pickupLocation.name}})}catch(e){if(console.error("Payment intent creation error:",e),e instanceof u.Z.errors.StripeError)return i.NextResponse.json({error:"Payment processing error",details:e.message},{status:400});return i.NextResponse.json({error:"Internal server error"},{status:500})}}let l=new n.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/stripe/create-payment-intent/route",pathname:"/api/stripe/create-payment-intent",filename:"route",bundlePath:"app/api/stripe/create-payment-intent/route"},resolvedPagePath:"c:\\Users\\priej\\skoot-transportation\\src\\app\\api\\stripe\\create-payment-intent\\route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:g,staticGenerationAsyncStorage:h,serverHooks:k}=l,b="/api/stripe/create-payment-intent/route";function y(){return(0,s.patchFetch)({serverHooks:k,staticGenerationAsyncStorage:h})}},20728:(e,t,r)=>{r.d(t,{_:()=>n});let o=require("@prisma/client"),n=globalThis.prisma??new o.PrismaClient},46029:(e,t,r)=>{r.d(t,{Ag:()=>o,GM:()=>a,po:()=>n}),r(55608);let o=new(r(48472)).Z(process.env.STRIPE_SECRET_KEY,{apiVersion:"2023-10-16",typescript:!0});function n(e,t,r){return o.webhooks.constructEvent(e,t,r)}function a(){let e=Date.now().toString().slice(-8),t=Math.random().toString(36).substring(2,6).toUpperCase();return`RCP-${e}-${t}`}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[8948,5972,8977],()=>r(42384));module.exports=o})();