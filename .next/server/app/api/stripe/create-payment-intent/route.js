"use strict";(()=>{var e={};e.id=798,e.ids=[798],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},61282:e=>{e.exports=require("child_process")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},21764:e=>{e.exports=require("util")},63980:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>y,patchFetch:()=>k,requestAsyncStorage:()=>g,routeModule:()=>l,serverHooks:()=>x,staticGenerationAsyncStorage:()=>h});var n={};r.r(n),r.d(n,{POST:()=>m,dynamic:()=>d});var o=r(49303),a=r(88716),s=r(60670),i=r(87070),u=r(48472),p=r(20728);let d="force-dynamic",c=new u.Z(process.env.STRIPE_SECRET_KEY,{apiVersion:"2023-10-16"});async function m(e){try{let{bookingId:t,amount:r,currency:n="usd"}=await e.json();if(!t||!r)return i.NextResponse.json({error:"Missing required fields: bookingId, amount"},{status:400});let o=await p._.booking.findUnique({where:{id:t},include:{departure:{include:{schedule:{include:{route:!0}}}},pickupLocation:!0,dropoffLocation:!0,user:!0,passengers:!0}});if(!o)return i.NextResponse.json({error:"Booking not found"},{status:404});if("PENDING"!==o.status)return i.NextResponse.json({error:"Booking payment already processed"},{status:400});let a=Math.round(100*o.totalAmount),s=Math.round(100*r);if(s!==a)return i.NextResponse.json({error:"Amount mismatch",expected:a/100,received:s/100},{status:400});let u=await c.paymentIntents.create({amount:a,currency:n,metadata:{bookingId:o.id,bookingNumber:o.bookingNumber,customerEmail:o.user.email,departureDate:o.departure.date.toISOString(),passengerCount:o.passengerCount.toString(),route:o.departure.schedule.route.name},description:`Skoot Transportation - ${o.departure.schedule.route.name} - ${o.passengerCount} passenger(s)`,receipt_email:o.user.email,automatic_payment_methods:{enabled:!0}});return await p._.payment.create({data:{bookingId:o.id,transactionId:u.id,amount:o.totalAmount,currency:n.toUpperCase(),status:"PENDING",paymentMethod:"STRIPE"}}),i.NextResponse.json({clientSecret:u.client_secret,paymentIntentId:u.id,amount:a,booking:{bookingNumber:o.bookingNumber,totalAmount:o.totalAmount,passengerCount:o.passengerCount,departure:{date:o.departure.date,time:o.departure.schedule.time,route:o.departure.schedule.route.name},pickupLocation:o.pickupLocation.name}})}catch(e){if(console.error("Payment intent creation error:",e),e instanceof u.Z.errors.StripeError)return i.NextResponse.json({error:"Payment processing error",details:e.message},{status:400});return i.NextResponse.json({error:"Internal server error"},{status:500})}}let l=new o.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/stripe/create-payment-intent/route",pathname:"/api/stripe/create-payment-intent",filename:"route",bundlePath:"app/api/stripe/create-payment-intent/route"},resolvedPagePath:"C:\\Users\\priej\\skoot-transportation\\src\\app\\api\\stripe\\create-payment-intent\\route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:g,staticGenerationAsyncStorage:h,serverHooks:x}=l,y="/api/stripe/create-payment-intent/route";function k(){return(0,s.patchFetch)({serverHooks:x,staticGenerationAsyncStorage:h})}},20728:(e,t,r)=>{r.d(t,{_:()=>o});let n=require("@prisma/client"),o=globalThis.prisma??new n.PrismaClient}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[276,972,472],()=>r(63980));module.exports=n})();