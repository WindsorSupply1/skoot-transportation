"use strict";(()=>{var e={};e.id=7751,e.ids=[7751],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},61282:e=>{e.exports=require("child_process")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},86624:e=>{e.exports=require("querystring")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},29067:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>N,patchFetch:()=>b,requestAsyncStorage:()=>h,routeModule:()=>y,serverHooks:()=>_,staticGenerationAsyncStorage:()=>w});var n={};r.r(n),r.d(n,{GET:()=>f,POST:()=>m,dynamic:()=>l});var a=r(49303),s=r(88716),i=r(60670),o=r(87070),u=r(20728),d=r(46029),p=r(75571),c=r(95456);let l="force-dynamic";async function m(e){try{let t=await (0,p.getServerSession)(c.Lz);if(!t?.user?.isAdmin)return o.NextResponse.json({error:"Unauthorized - Admin access required"},{status:401});let{bookingId:r,reason:n,amount:a,notifyCustomer:s=!0}=await e.json();if(!r)return o.NextResponse.json({error:"Booking ID is required"},{status:400});let i=await u._.booking.findUnique({where:{id:r},include:{payment:!0,user:!0,departure:{include:{schedule:{include:{route:!0}}}},pickupLocation:!0,dropoffLocation:!0}});if(!i)return o.NextResponse.json({error:"Booking not found"},{status:404});if(!i.payment||"COMPLETED"!==i.payment.status)return o.NextResponse.json({error:"No completed payment found for this booking"},{status:400});if("REFUNDED"===i.status)return o.NextResponse.json({error:"Booking has already been refunded"},{status:400});let l=i.payment.transactionId;if(!l)return o.NextResponse.json({error:"No payment transaction ID found"},{status:400});let m=Math.round(100*i.payment.amount),f=a?Math.round(100*a):m;if(f>m)return o.NextResponse.json({error:"Refund amount cannot exceed original payment amount"},{status:400});if(f<=0)return o.NextResponse.json({error:"Refund amount must be greater than zero"},{status:400});let y=await d.Ag.refunds.create({payment_intent:l,amount:f,reason:n?"requested_by_customer":"duplicate",metadata:{bookingId:i.id,bookingNumber:i.bookingNumber,adminUserId:t.user.id,reason:n||"Admin initiated refund"}}),h=f===m;return await u._.payment.update({where:{id:i.payment.id},data:{status:h?"REFUNDED":"PARTIALLY_REFUNDED",refundedAt:new Date,refundAmount:f/100,refundReason:n||"Admin initiated refund"}}),await u._.booking.update({where:{id:r},data:{status:"REFUNDED",cancelledAt:new Date,adminNotes:`Refunded $${f/100} - ${n||"Admin initiated refund"}`}}),await u._.departure.update({where:{id:i.departureId},data:{bookedSeats:{decrement:i.passengerCount}}}),i.returnDepartureId&&await u._.departure.update({where:{id:i.returnDepartureId},data:{bookedSeats:{decrement:i.passengerCount}}}),s&&i.user?.email,await g({action:"REFUND_PROCESSED",bookingId:i.id,stripeRefundId:y.id,originalAmount:m/100,refundAmount:f/100,reason:n,adminUserId:t.user.id,isFullRefund:h}),console.log(`Refund processed: 
      Booking: ${r}
      Amount: $${f/100}
      Stripe Refund: ${y.id}
      Status: ${y.status}`),o.NextResponse.json({success:!0,refund:{id:y.id,amount:f/100,status:y.status,bookingNumber:i.bookingNumber,isFullRefund:h}})}catch(e){if(console.error("Refund processing error:",e),e instanceof Error)return o.NextResponse.json({error:e.message},{status:500});return o.NextResponse.json({error:"Failed to process refund"},{status:500})}}async function f(e){try{let t=await (0,p.getServerSession)(c.Lz);if(!t?.user?.isAdmin)return o.NextResponse.json({error:"Unauthorized - Admin access required"},{status:401});let{searchParams:r}=new URL(e.url),n=r.get("bookingId");if(!n)return o.NextResponse.json({error:"Booking ID is required"},{status:400});let a=await u._.booking.findUnique({where:{id:n},include:{payment:!0}});if(!a)return o.NextResponse.json({error:"Booking not found"},{status:404});let s={bookingId:a.id,bookingNumber:a.bookingNumber,status:a.status,paymentStatus:a.payment?.status,originalAmount:a.payment?.amount,refundAmount:a.payment?.refundAmount,refundedAt:a.payment?.refundedAt,refundReason:a.payment?.refundReason,canRefund:a.payment?.status==="COMPLETED"&&"REFUNDED"!==a.status};return o.NextResponse.json(s)}catch(e){return console.error("Refund status fetch error:",e),o.NextResponse.json({error:"Failed to fetch refund status"},{status:500})}}async function g(e){try{let t={timestamp:new Date().toISOString(),service:"stripe-refund",...e};console.log("REFUND_AUDIT_LOG:",JSON.stringify(t))}catch(e){console.error("Failed to create refund audit log:",e)}}let y=new a.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/stripe/refund/route",pathname:"/api/stripe/refund",filename:"route",bundlePath:"app/api/stripe/refund/route"},resolvedPagePath:"C:\\Users\\priej\\skoot-transportation\\src\\app\\api\\stripe\\refund\\route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:h,staticGenerationAsyncStorage:w,serverHooks:_}=y,N="/api/stripe/refund/route";function b(){return(0,i.patchFetch)({serverHooks:_,staticGenerationAsyncStorage:w})}},69955:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},75571:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0});var n={};Object.defineProperty(t,"default",{enumerable:!0,get:function(){return s.default}});var a=r(69955);Object.keys(a).forEach(function(e){!("default"===e||"__esModule"===e||Object.prototype.hasOwnProperty.call(n,e))&&(e in t&&t[e]===a[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return a[e]}}))});var s=function(e,t){if(e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var r=i(void 0);if(r&&r.has(e))return r.get(e);var n={__proto__:null},a=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var s in e)if("default"!==s&&({}).hasOwnProperty.call(e,s)){var o=a?Object.getOwnPropertyDescriptor(e,s):null;o&&(o.get||o.set)?Object.defineProperty(n,s,o):n[s]=e[s]}return n.default=e,r&&r.set(e,n),n}(r(45609));function i(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,r=new WeakMap;return(i=function(e){return e?r:t})(e)}Object.keys(s).forEach(function(e){!("default"===e||"__esModule"===e||Object.prototype.hasOwnProperty.call(n,e))&&(e in t&&t[e]===s[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return s[e]}}))})},95456:(e,t,r)=>{r.d(t,{Lz:()=>p,QO:()=>l,c_:()=>m,ts:()=>c});var n=r(45609),a=r(20728),s=r(53797),i=r(77234),o=r(13539),u=r(42023),d=r.n(u);let p={adapter:(0,o.N)(a._),secret:"your-secret-key-here-make-it-long-and-random",providers:[(0,i.Z)({clientId:process.env.GOOGLE_CLIENT_ID,clientSecret:process.env.GOOGLE_CLIENT_SECRET,authorization:{params:{prompt:"consent",access_type:"offline",response_type:"code",scope:"openid email profile"}}}),{id:"amazon",name:"Amazon",type:"oauth",authorization:{url:"https://www.amazon.com/ap/oa",params:{scope:"profile",response_type:"code"}},token:"https://api.amazon.com/auth/o2/token",userinfo:"https://api.amazon.com/user/profile",clientId:process.env.AMAZON_CLIENT_ID,clientSecret:process.env.AMAZON_CLIENT_SECRET,profile:e=>({id:e.user_id,name:e.name,email:e.email,image:null})},(0,s.Z)({name:"credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e){if(!e?.email||!e?.password)return null;try{let t=await a._.user.findUnique({where:{email:e.email.toLowerCase()}});if(!t)return null;return{id:t.id,email:t.email,name:`${t.firstName} ${t.lastName}`,image:t.image,isAdmin:t.isAdmin}}catch(e){return console.error("Authentication error:",e),null}}})],session:{strategy:"jwt",maxAge:2592e3,updateAge:86400},jwt:{maxAge:2592e3},callbacks:{async signIn({user:e,account:t,profile:r}){if(t?.provider==="google"||t?.provider==="amazon")try{let t=await a._.user.findUnique({where:{email:e.email}});if(t)!t.image&&e.image&&await a._.user.update({where:{id:t.id},data:{image:e.image}});else{let r=e.name?.split(" ")||["",""];t=await a._.user.create({data:{email:e.email,firstName:r[0]||"Guest",lastName:r.slice(1).join(" ")||"User",image:e.image,emailVerified:new Date,customerType:"REGULAR"}})}}catch(e){return console.error(`Error during ${t.provider} sign in:`,e),!1}return!0},async jwt({token:e,user:t,account:r}){if(t){let r=await a._.user.findUnique({where:{email:t.email}});r&&(e.isAdmin=r.isAdmin,e.userId=r.id,e.firstName=r.firstName,e.lastName=r.lastName)}return e},session:async({session:e,token:t})=>(t&&(e.user.id=t.userId,e.user.isAdmin=t.isAdmin,e.user.name=`${t.firstName} ${t.lastName}`),e)},pages:{signIn:"/auth/signin",error:"/auth/error"},cookies:{sessionToken:{name:"__Secure-next-auth.session-token",options:{httpOnly:!0,sameSite:"lax",path:"/",secure:!0}},callbackUrl:{name:"__Secure-next-auth.callback-url",options:{httpOnly:!0,sameSite:"lax",path:"/",secure:!0}},csrfToken:{name:"__Host-next-auth.csrf-token",options:{httpOnly:!0,sameSite:"lax",path:"/",secure:!0}}},useSecureCookies:!0,debug:!1};async function c(){try{let e=await (0,n.getServerSession)(p);if(!e?.user?.email)return null;let t=await a._.user.findUnique({where:{email:e.user.email},select:{id:!0,email:!0,firstName:!0,lastName:!0,isAdmin:!0}});if(!t)return null;return{id:t.id,email:t.email,name:`${t.firstName} ${t.lastName}`,isAdmin:t.isAdmin}}catch(e){return console.error("Error getting current user:",e),null}}async function l(e,t,r){try{let n=await c();if(!n)return new Response(JSON.stringify({error:"Authentication required"}),{status:401,headers:{"Content-Type":"application/json"}});if(r&&!n.isAdmin)return new Response(JSON.stringify({error:"Admin access required"}),{status:403,headers:{"Content-Type":"application/json"}});return await t(e,n)}catch(e){return console.error("Auth middleware error:",e),new Response(JSON.stringify({error:"Authentication failed"}),{status:500,headers:{"Content-Type":"application/json"}})}}async function m(e){return await d().hash(e,12)}},20728:(e,t,r)=>{r.d(t,{_:()=>a});let n=require("@prisma/client"),a=globalThis.prisma??new n.PrismaClient},46029:(e,t,r)=>{r.d(t,{Ag:()=>n,GM:()=>s,po:()=>a}),r(55608);let n=new(r(48472)).Z(process.env.STRIPE_SECRET_KEY,{apiVersion:"2023-10-16",typescript:!0});function a(e,t,r){return n.webhooks.constructEvent(e,t,r)}function s(){let e=Date.now().toString().slice(-8),t=Math.random().toString(36).substring(2,6).toUpperCase();return`RCP-${e}-${t}`}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[8948,5972,3678,8977],()=>r(29067));module.exports=n})();