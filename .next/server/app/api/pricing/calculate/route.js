"use strict";(()=>{var e={};e.id=2397,e.ids=[2397],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},92433:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>x,patchFetch:()=>v,requestAsyncStorage:()=>g,routeModule:()=>m,serverHooks:()=>h,staticGenerationAsyncStorage:()=>f});var i={};r.r(i),r.d(i,{GET:()=>d,POST:()=>l,dynamic:()=>c});var a=r(49303),n=r(88716),o=r(60670),s=r(87070),u=r(20728);let c="force-dynamic";async function l(e){try{let t;let{routeId:r,passengerCount:i,customerType:a="REGULAR",ticketType:n="ADULT",isRoundTrip:o=!1,extraLuggageBags:c=0,petCount:l=0,promoCode:d}=await e.json();if(!r||!i||i<1)return s.NextResponse.json({error:"Invalid pricing request parameters"},{status:400});let m=await u._.pricingTier.findFirst({where:{customerType:a,isActive:!0,validFrom:{lte:new Date},OR:[{validTo:null},{validTo:{gte:new Date}}]},orderBy:{createdAt:"desc"}});if(!m)return s.NextResponse.json({error:"No active pricing found for customer type"},{status:404});let g=m.basePrice;switch(n){case"CHILD":g*=.75;break;case"SENIOR":g*=.85}let f=g*i,h={basePrice:g,passengerCount:i},x=0,v=0;if("STUDENT"===a){let e=.1*f;x+=e,h.customerDiscount=e}else if("MILITARY"===a){let e=.15*f;x+=e,h.customerDiscount=e}if(o){let e=.1*f;x+=e,h.roundTripDiscount=e}if(c>0){let e=10*c;v+=e,h.extraLuggageFee=e}if(l>0){let e=15*l;v+=e,h.petFee=e}if(d){let e=await p(d,f-x+v);e>0&&(x+=e,h.promoDiscount=e,t=d)}let R=Math.max(0,f-x+v),w=Math.round((.029*R+.3)*100)/100;v+=w,h.processingFee=w;let y=(R+w)*0;h.taxAmount=y;let T={subtotal:Math.round(100*f)/100,discounts:Math.round(100*x)/100,fees:Math.round(100*v)/100,taxes:Math.round(100*y)/100,total:Math.round((R+w+y)*100)/100,breakdown:h,...t&&{promoCodeApplied:t}};return s.NextResponse.json(T)}catch(e){return console.error("Pricing calculation error:",e),s.NextResponse.json({error:"Failed to calculate pricing"},{status:500})}}async function p(e,t){try{let r=e.toUpperCase();switch(r){case"WELCOME10":return Math.min(.1*t,20);case"STUDENT15":return .15*t;case"FIRSTRIDE":return Math.min(.2*t,25);case"SAVE5":return Math.min(5,t);default:let i=await u._.siteSettings.findUnique({where:{key:`promo_${r.toLowerCase()}`}});if(i&&i.value)try{let e=JSON.parse(i.value);if(e.active&&new Date<=new Date(e.expiresAt)){if("percentage"===e.type){let r=e.value/100*t;return e.maxDiscount?Math.min(r,e.maxDiscount):r}if("fixed"===e.type)return Math.min(e.value,t)}}catch(e){console.error("Error parsing promo code data:",e)}return 0}}catch(e){return console.error("Error applying promo code:",e),0}}async function d(e){try{let{searchParams:t}=new URL(e.url),r=t.get("routeId");if(!r)return s.NextResponse.json({error:"Route ID is required"},{status:400});let i=await u._.pricingTier.findMany({where:{isActive:!0,validFrom:{lte:new Date},OR:[{validTo:null},{validTo:{gte:new Date}}]},orderBy:{customerType:"asc"}}),a=await u._.route.findUnique({where:{id:r},select:{id:!0,name:!0,origin:!0,destination:!0,duration:!0}});if(!a)return s.NextResponse.json({error:"Route not found"},{status:404});return s.NextResponse.json({route:a,pricingTiers:i.map(e=>({customerType:e.customerType,basePrice:e.basePrice,description:e.description})),fees:{extraLuggage:10,pet:15,processingRate:2.9,processingFixed:.3},discounts:{child:.25,senior:.15,student:.1,military:.15,roundTrip:.1}})}catch(e){return console.error("Route pricing fetch error:",e),s.NextResponse.json({error:"Failed to fetch route pricing"},{status:500})}}let m=new a.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/pricing/calculate/route",pathname:"/api/pricing/calculate",filename:"route",bundlePath:"app/api/pricing/calculate/route"},resolvedPagePath:"C:\\Users\\priej\\skoot-transportation\\src\\app\\api\\pricing\\calculate\\route.ts",nextConfigOutput:"",userland:i}),{requestAsyncStorage:g,staticGenerationAsyncStorage:f,serverHooks:h}=m,x="/api/pricing/calculate/route";function v(){return(0,o.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:f})}},20728:(e,t,r)=>{r.d(t,{_:()=>a});let i=require("@prisma/client"),a=globalThis.prisma??new i.PrismaClient}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),i=t.X(0,[8948,5972],()=>r(92433));module.exports=i})();